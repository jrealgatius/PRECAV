---
title: 'PRECAV: Caracterización del riesgo cardiovascular a una edad prematura
  en Cataluña (PREPARACIÓ)'
author: "Jordi Real"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
  pdf_document: default
  word_document: default
params:
  evaluar: TRUE
---


# Càrrega de funcions  

```{r setup, include=F}
library(knitr)
knitr::opts_chunk$set(
	eval = params$evaluar,
	echo = FALSE,
	error = FALSE,
	warning = FALSE,
	include = FALSE
)

rm(list=ls())

link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)

library(dplyr)
library(here)


```

# 1. DIRECTORI DE TREBALL              

>> Inicialització de parametres  

```{r inicialitzacio, eval=TRUE}

library(here)

fitxer_input<-"BD_PRECAV_test5.rds"
fitxer_input<-here::here("dades/preparades",fitxer_input)

dades_flow<-here::here("dades","dades_flow.rds")

output_PRECAV<-"output_PRECAV_v2.Rdata"
output_PRECAV<-"output/R_data" %>% here::here(output_PRECAV)

conductor_variables<-here::here("variables_precav.xls")


```


# 1. Lectura de fitxer

```{r lectura, eval=T}

dades<-readRDS(fitxer_input) %>% as_tibble()

dades_flow<-readRDS(dades_flow) 

```

# 2. Calculs i Recodificacions  ----------------

```{r calculs, eval=T}

library(lubridate)

##  Calcular edat 

dades<-dades %>% 
  mutate(edat = year(as.period(interval(start = ymd(dnaix), end = dtindex))))


# Farmacs 
# NA --> 0 (Else=1) (No hi ha 0'0)
dades<-dades %>% mutate_at(vars(starts_with("FP.")),
                           ~if_else(is.na(.) | .==0,0,1)) 

dades<-dades %>% mutate_at(vars(starts_with("FP1_3a.")), 
                           ~if_else(is.na(.) | .== 0,0,1)) 


# NA --> 0 (ALTRI ES UNA COPIA)
dades<-dades %>% mutate_at(vars(starts_with("FD.")), 
                           ~if_else(is.na(.) | .==0,0,1)) 

# NA --> 0 (ALTRI ES UNA COPIA)
dades<-dades %>% mutate_at(vars(starts_with("FD1_3a.")), 
                           ~if_else(is.na(.) | .==0,0,1)) 



# Diagnostics
# NA --> 0 (Else=1) (No hi ha 0)
dades<-dades %>% mutate_at(vars(starts_with("DG.")), 
                           ~if_else(is.na(.) | .==0,0,1)) 

# Diagnostics (ANTECEDENTS)
# NA --> 0 (Else=1) (No hi ha 0)
dades<-dades %>% mutate_at(vars(starts_with("ANT1_3.")), 
                           ~if_else(is.na(.) | .==0,0,1)) 

# Events
dades<-dades %>% mutate_at(vars(starts_with("EV.")), 
                           ~if_else(is.na(.) | .==0,0,1) ) 

# Càlcul de número d'events Terciaris

dades<-dades %>% mutate(
  EV.TER_SUM = rowSums(select(., starts_with("EV.TER."))))

# Recode EV.TER_SUM
dades<-dades %>% mutate(
  EV.TER_multi = case_when(
    EV.TER_SUM==1~"1 terr",
    EV.TER_SUM>1~">=2 terr")
  )

# Càlcul de número d'events tipus

dades<-dades %>% mutate(
  EV.TIP_SUM = rowSums(select(., starts_with("EV.TIP.")))
  )

# Recode EV.TIP_SUM

dades<-dades %>% mutate(
  EV.TIP_multi = case_when(
  EV.TIP_SUM==1~"1 ECV",
  EV.TIP_SUM>1~">=2 ECVs")
  )

# visites 
dades<-dades %>% mutate_at(vars(starts_with("visites_")), 
                           ~if_else(is.na(.) | .==0,0,.) )

# Recodes
dades<-dades %>% 
  mutate(edat_pre=ifelse(sexe=="H" & edat<55,"Young man(<55)",NA)) %>% 
  mutate(edat_pre=ifelse(sexe=="H" & edat>=55,"Old man(>=55)",edat_pre)) %>% 
  mutate(edat_pre=ifelse(sexe=="D" & edat<65,"Young woman(<65)",edat_pre)) %>% 
  mutate(edat_pre=ifelse(sexe=="D" & edat>=65,"Old woman(>=65)",edat_pre)) 

# Recodes
dades<-dades %>% 
  mutate(edat_grup=ifelse((sexe=="H" & edat<55) | (sexe=="D" & edat<65) ,"Young:M<55/F<65",NA)) %>% 
  mutate(edat_grup=ifelse((sexe=="H" & edat>=55) | (sexe=="D" & edat>=65),"Old:M>=55/F>=65",edat_grup))  

# Recodes
dades<-dades %>% 
  mutate(any_index=factor(lubridate::year(dtindex)))

# REGICOR  ------------------

# Selecciono variables REGICOR i formatejo 
# Ojo que s'ha de recalcular la edat 1-3 anys previs 
# S'ha eliminat ANT1_3.E10 (Ja no existeix)

dades_regicor<-selectorvariables("regicor",taulavariables=conductor_variables,dt=dades) %>% 
  mutate(age=edat,
         diabetes=if_else(ANT1_3.E11==1,1,0),
         smoker=if_else(tab.valor==1,1,0,missing = 0), 
         coltot=COLTOT.valor13a,
         colhdl=COLHDL.valor13a,
         sbp=PAS.valor13a,
         dbp=PAD.valor13a) 
  

# Aplico formula i ho fuciono a dades
temp<-dades_regicor
regicor_df<-regicor(temp$age,temp$sexe,temp$smoker,temp$diabetes,temp$coltot,temp$colhdl,temp$sbp,temp$dbp) 

regicor_df<-tibble(regicor_df) %>% rename(regicor=regicor_df)

dades<-dades %>% bind_cols(regicor_df)

rm(temp,dades_regicor,regicor_df)


# Variables Noves Emilio Ortega --------------

# HDL BAJO:  hdlbajo13a_cat2 (1-3a=ultims 3 anys)

dades<-dades %>% 
  mutate(hdlbajo13a_cat2=case_when(
    sexe=="H" & COLHDL.valor13a < 40 ~ "Si",
    sexe=="D" & COLHDL.valor13a < 50 ~ "Si",
    sexe=="H" & COLHDL.valor13a >=40 ~ "No",
    sexe=="D" & COLHDL.valor13a >=50 ~ "No"))

# Dislipemia aterogénica disl13a_cat2  (Any Missings = missings)

dades<-dades %>% 
  mutate(disl13a_cat2=case_when(
    TG.valor13a>200 & hdlbajo13a_cat2=="Si"~ "Si",
    TG.valor13a>200 & hdlbajo13a_cat2=="No"~ "No",
    TG.valor13a<=200 & hdlbajo13a_cat2=="Si"~ "No",
    TG.valor13a<=200 & hdlbajo13a_cat2=="No"~ "No")) 
                 
# Colesterol remanente: col_rema13a
dades<-dades %>% mutate(col_rema13a=COLTOT.valor13a-COLLDL.valor13a-COLHDL.valor13a) 

# Colesterol noHDL: col_noHDL13a 

dades<-dades %>% mutate(col_noHDL13a=COLTOT.valor13a--COLHDL.valor13a) 

# regicor_cat (DM1 no te regicor)
dades<-dades %>% mutate(regicor_cat=case_when(
  regicor<4.51~1,
  regicor>=4.51 & regicor<=9.51~2,
  regicor>=9.51 & regicor<=14.51~3,
  regicor>=14.51 ~4)) 

# FHF_cat (fenotipo hipercolesterolemia familiar) -----
dades<-dades %>% 
  mutate(FHF_cat=case_when(
    COLLDL.valor13a>=230 & edat<30~1,
    COLLDL.valor13a>=238 & edat>=30 & edat<39~1,
    COLLDL.valor13a>=260 & edat>=40 & edat<49~1,
    COLLDL.valor13a>=265 & edat>=49~1)) %>% 
  mutate(FHF_cat=case_when(
    !is.na(COLLDL.valor13a) & is.na(FHF_cat)~0,
    !is.na(COLLDL.valor13a) & FHF_cat==1~1))

# DG.HTA_O + DG.COMP_HTA ----------------
dades<-dades %>% mutate(DG.HTA=if_else(DG.HTA_O==1 | DG.COMP_HTA==1,1,0))


# Recodes

dades<-recodificar(dades,taulavariables = conductor_variables,criteris = "recodes")


```

# 3. Criteris d'inclusió

* Casos sense control
* Edad entre 35 y 75 anys)   
* Sense per FA ni DM1 en data index

```{r filtratje, eval=T}
# Dades flow-chart

# Aplicar filtre 0: Nombre mínim de controls per cas
Nmin_Crl_Cas<-1 # Nombre mínim de controls per cas 
Freq_Exc0<-table(dades$numControls>=Nmin_Crl_Cas)[1] %>% as.numeric()
# Afegir a dades_flow
dades_flow<-add_row(dades_flow,x=c(5,6),tipus=c("Control","Cas"),etiqueta=c("Not Controls matched","Not Controls matched"),N=c(0,Freq_Exc0))
# Filtre
dades<-dades %>% filter(numControls>=Nmin_Crl_Cas)

# Actualitzar exclusio postmatch
excl_postM<-dades_flow %>% filter(etiqueta=="Inicial") %>% pull(N)-dades_flow %>% filter(etiqueta=="Post_Match") %>% pull(N)
dades_flow<-add_row(dades_flow,x=c(7,8),tipus=c("Control","Cas"),etiqueta=c("Not matching","Not matching"),N=excl_postM)

# Aplicar filtre I (Per rang d'edat)
Freq_pre_exc1<-table(dades$event) %>% as.vector()
dades<-dades %>% filter(edat>=35 & edat<75)
Freq_post_exc1<-table(dades$event) %>% as.vector()

dades_flow<-add_row(dades_flow,x=c(7,8),tipus=c("Control","Cas"),etiqueta=c("Fuera rango","Fuera de rango(35-75)"),N=Freq_pre_exc1-Freq_post_exc1)


# Aplicar filtre II (Per E10)
temp<-dades %>% filter(DG.E10==1) 
Freq_exc<-table(temp$event) %>% as.vector()
dades<-dades %>% filter(DG.E10==0)
# Actualitzar dades flow chart
dades_flow<-add_row(dades_flow,x=c(9,10),tipus=c("Control","Cas"),etiqueta=c("DM1","DM1"),N=Freq_exc2)

# Aplicar filtre II (Per E10)
temp<-dades %>% filter(DG.FA==1) 
Freq_exc<-table(temp$event) %>% as.vector()
dades<-dades %>% filter(DG.FA==0)
# Actualitzar dades flow chart
dades_flow<-add_row(dades_flow,x=c(9,10),tipus=c("Control","Cas"),etiqueta=c("FA","FA"),N=Freq_exc)

# Actualitzar dades finals flowchart
dades_flow<-add_row(dades_flow,x=c(11,12),tipus=c("Control","Cas"),etiqueta=c("Final","Final"),N=table(dades$event) %>% as.vector())

# Verificació de filtres i salvar base d'events
events_dt <-dades %>% filter(event==1) 
events_dt %>% skimr::skim(edat)

```



```{r flow}

# Generar Flow_chart 

# Configuro parametres del flowchart
pob_lab<-"Población inicial (8%)"
pob_lab1<-c("Potenciales controles","Controles")
pob_lab2=c("Potenciales casos","Casos")

# N inicial

Ninicial<-dades_flow %>% filter(etiqueta=="Inicial") %>% pull(N) %>% sum()

NControls_inicial_final<-dades_flow %>% filter(tipus=="Control" & (etiqueta=="Inicial" | etiqueta=="Final")) %>% pull(N) 
NCas_inicial_final<-dades_flow %>% filter(tipus=="Cas" & (etiqueta=="Inicial" | etiqueta=="Final")) %>% pull(N) 

Nexcl_controls<-dades_flow %>% filter(tipus=="Control" & etiqueta!="Inicial" & etiqueta!="Final" & etiqueta!="Post_Match") %>% pull(N) 
Labexcl_controls<-dades_flow %>% filter(tipus=="Control" & etiqueta!="Inicial" & etiqueta!="Final" & etiqueta!="Post_Match") %>% pull(etiqueta) 

Nexcl_cas<-dades_flow %>% filter(tipus=="Cas" & etiqueta!="Inicial" & etiqueta!="Final" & etiqueta!="Post_Match") %>% pull(N) 
Labexcl_cas<-dades_flow %>% filter(tipus=="Cas" & etiqueta!="Inicial" & etiqueta!="Final" & etiqueta!="Post_Match") %>% pull(etiqueta) 


flow_chart<-diagramaFlowchart2G(pob_lab=pob_lab,
                                pob=Ninicial,
                                pob_lab1=pob_lab1,
                                pob_lab2=pob_lab2,
                                
                                pob1=NControls_inicial_final, # Controls inicials i finals  
                                pob2=NCas_inicial_final, # Casos inicials i finals 
                                
                                exc1=Nexcl_controls,
                                exc_lab1=Labexcl_controls,
                                
                                
                                exc2=Nexcl_cas,
                                exc_lab2=Labexcl_cas)


# Dades flow-chart
n_controls_final<-table(dades$event)[1]
n_casos_final<-table(dades$event)[2]

n_controls_exc2<-n_controls_inicial-n_controls_final
n_casos_exc2<-n_casos_inicial-n_casos_final


```




# 4. Etiquetació / factorització

Factoritzar NO.Yes llista de variables "factor" situades a la taulavariables camp=factor


```{r etiquetacio, eval=F}

dades<-factoritzar.NO.YES(dt=dades,columna="factor.YESNO",taulavariables=conductor_variables)

# Value labels
dades<-etiquetar_valors(dades,variables_factors = conductor_variables,fulla="value_label")

# Etiquetar 
dades<-etiquetar(d=dades,taulavariables = conductor_variables)


```

# 5. Generar Flow-chart

```{r flow_chart, eval=T, include=T}
# Extrec dades de flow chart pre i post maatching 
N_casos<-dades_flow %>% filter(nom=="N_cas") %>% select(N) %>% as.numeric()
N_controls<-dades_flow %>% filter(nom=="N_control") %>% select(N) %>% as.numeric()
LAB_casos<-dades_flow %>% filter(nom=="N_cas") %>% select(lab) %>% as.character()
LAB_controls<-dades_flow %>% filter(nom=="N_control") %>% select(lab) %>% as.character()

Nf_casos<-dades_flow %>% filter(nom=="N_cas_f") %>% select(N) %>% as.numeric()
Nf_controls<-dades_flow %>% filter(nom=="N_control_f") %>% select(N) %>% as.numeric()

# Excloc els de fora de rang en N finals
Nfinal_casos=Nf_casos-n_casos_exc2
Nfinal_controls=Nf_controls-n_controls_exc2

# Labels
LABf_casos<-dades_flow %>% filter(nom=="N_cas_f") %>% select(lab) %>% as.character()
LABf_controls<-dades_flow %>% filter(nom=="N_control_f") %>% select(lab) %>% as.character()

# Configuro parametres del flowchart
pob_lab<-"Población inicial (8%)"
pob_lab1<-c("Potenciales controles","Controles")
pob_lab2=c("Potenciales casos","Casos")
pob<-N_casos+N_controls

pob1<-c(N_controls,Nfinal_controls)
exc1<-c(Nf_controls-N_controls, n_controls_exc2)
exc_lab1<-c('Not matching','Fuera rango edad')

pob2<-c(N_casos,Nfinal_casos)
exc2<-c(N_casos-Nf_casos,n_casos_exc2)
exc_lab2<-c("Not matching","Fuera rango edad(35-75)")

flow_chart<-diagramaFlowchart2G(pob_lab=pob_lab,
                                pob=N_casos+N_controls,
                                pob_lab1=pob_lab1,
                                pob_lab2=pob_lab2,
                                pob1=pob1,
                                exc1=exc1,
                                exc_lab1=exc_lab1,
                                pob2=pob2,
                                exc2=exc2,
                                exc_lab2=exc_lab2)

flow_chart

```

# 6. Analisis preliminar  

>- Descripció dels events

```{r descriptiva, include=F, eval = F}


dadesevents<-dades %>% filter(event==1)

formula<-formula_compare(x="events",y="",taulavariables = conductor_variables) 
T1.EVENTS<-descrTable(formula,data=dadesevents,show.p.overall = F,hide.no = "No")

formula<-formula_compare(x="events_ter",y="",taulavariables = conductor_variables) 
T1.2.EVENTS<-descrTable(formula,data=dadesevents,show.p.overall = F,hide.no = "No")

formula<-formula_compare(x="events_imp",y="",taulavariables = conductor_variables) 
T1.3.EVENTS<-descrTable(formula,data=dadesevents,show.p.overall = F,hide.no = "No")

formula<-formula_compare(x="farmacs",y="",taulavariables = conductor_variables) 
T1.FARMACS<-descrTable(formula,data=dadesevents,show.p.overall = F,hide.no = "No")

formula<-formula_compare(x="baseline",y="",taulavariables = conductor_variables) 
T1.BASELINE<-descrTable(formula,data=dadesevents,show.p.overall = F,hide.no = "No")

```

>- Comparativa amb controls

```{r comparativa, include=F, eval=F}
# Tecnica per no arrossegar tota la base de dades
formula<-formula_compare(x="events",y="event",taulavariables = conductor_variables) 
dades_temp<-dades %>% select(extreure.variables("events",conductor_variables),"event")
T2.EVENTS<-descrTable(formula,data=dades_temp,show.p.overall = F,hide.no = "No")

formula<-formula_compare(x="farmacs_previs",y="event",taulavariables = conductor_variables) 
dades_temp<-dades %>% select(extreure.variables("farmacs_previs",conductor_variables),"event")
T2.FARMACS<-descrTable(formula,data=dades_temp,show.p.overall = F,hide.no = "No")

formula<-formula_compare(x="farmacs",y="event",taulavariables = conductor_variables) 
dades_temp<-dades %>% select(extreure.variables("farmacs",conductor_variables),"event")
T2.FARMACS_ACTUALS<-descrTable(formula,data=dades_temp,show.p.overall = F,hide.no = "No")

formula<-formula_compare(x="antecedents_previs",y="event",taulavariables = conductor_variables) 
dades_temp<-dades %>% select(extreure.variables("antecedents_previs",conductor_variables),"event")
T2.ANTECEDENTS<-descrTable(formula,data=dades_temp,show.p.overall = F,hide.no = "No",show.n = T)

formula<-formula_compare(x="valors_previs",y="event",taulavariables = conductor_variables) 
dades_temp<-dades %>% select(extreure.variables("valors_previs",conductor_variables),"event")
T2.VALORS<-descrTable(formula,data=dades_temp,show.p.overall = F,hide.no = "No",show.n = T)

formula<-formula_compare(x="regicor",y="event",taulavariables = conductor_variables) 
dades_temp<-dades %>% select(extreure.variables("regicor",conductor_variables),"event")
T2.regicor<-descrTable(formula,data=dades_temp,show.p.overall = F,hide.no = "No",show.n = T,show.ratio = T)


```

>- Comparativa amb controls per grups de edad (edat_grup) 

```{r comparativa_edat, include=F, eval=F}
formula<-formula_compare(x="regicor",y="event",taulavariables = conductor_variables) 
dades_temp<-dades %>% filter(edat_grup=="Young:M<55/F<65") %>% select(extreure.variables("regicor",conductor_variables),"event")
T2.regicor_g1<-descrTable(formula,data=dades_temp,show.p.overall = F,hide.no = "No",show.n = T,show.ratio = T)

formula<-formula_compare(x="regicor",y="event",taulavariables = conductor_variables) 
dades_temp<-dades %>% filter(edat_grup=="Old:M>=55/F>=65") %>% select(extreure.variables("regicor",conductor_variables),"event")
T2.regicor_g2<-descrTable(formula,data=dades_temp,show.p.overall = F,hide.no = "No",show.n = T,show.ratio = T)

```

>- Evaluar Regicor 

>> Métode: Models Logistics condicionals de: Regicor / variables incloses en Regicor / Variables regicor + farmacs 

```{r regicor, include=F, eval=F}

dades_temp<-dades

M1.reg.alon.ls<-extreure_model_logistic(x="regicor_alone",y="event",taulavariables=conductor_variables,dades=dades_temp,valor_outcome=1,conditional = T,strata = "caseid")
M2.reg.vars.ls<-extreure_model_logistic(x="regicor_vars",y="event",taulavariables=conductor_variables,dades=dades_temp,valor_outcome=1,conditional = T,strata = "caseid")
M3.reg.plus.ls<-extreure_model_logistic(x="regicor_plus",y="event",taulavariables=conductor_variables,dades=dades_temp,valor_outcome=1,conditional = T,strata = "caseid")


```

>- Evaluar Regicor GLOBAL / Subgrups  

```{r regicor_global, include=F, eval=F}

library(plotROC)
ROC.reg.alone.plot<-ggplot(dades, aes(d = event, m = regicor,color=edat_grup)) + 
  plotROC::geom_roc(n.cuts = 0) + 
  plotROC::style_roc()

ROC.reg.alone.plot <- ROC.reg.alone.plot + style_roc(theme = theme_grey) +
  theme(axis.text = element_text(colour = "blue")) +
  ggtitle("ROC Curve") +
  annotate("text", x = .75, y = .25,
             label = paste("AUC =", round(plotROC::calc_auc(ROC.reg.alone.plot)["AUC"], 2))) 

```

>- Evaluar Regicor Grup d'edat Joves (G1)

```{r regicor_joves, eval=F, include=F}
dades_temp<-dades %>% filter(edat_grup=="Young:M<55/F<65")
M1.reg.alon.G1.ls<-extreure_model_logistic(x="regicor_alone",y="event",taulavariables=conductor_variables,dades=dades_temp,valor_outcome=1,conditional = T,strata = "caseid")
M2.reg.vars.G1.ls<-extreure_model_logistic(x="regicor_vars",y="event",taulavariables=conductor_variables,dades=dades_temp,valor_outcome=1,conditional = T,strata = "caseid")
M3.reg.plus.G1.ls<-extreure_model_logistic(x="regicor_plus",y="event",taulavariables=conductor_variables,dades=dades_temp,valor_outcome=1,conditional = T,strata = "caseid")

```

>- Evaluar Regicor Grup d'edat Joves (G2)

```{r regicor_g2, include=F, eval=F}

dades_temp<-dades %>% filter(edat_grup=="Old:M>=55/F>=65")
M1.reg.alon.G2.ls<-extreure_model_logistic(x="regicor_alone",y="event",taulavariables=conductor_variables,dades=dades_temp,valor_outcome=1,conditional = T,strata = "caseid")
M2.reg.vars.G2.ls<-extreure_model_logistic(x="regicor_vars",y="event",taulavariables=conductor_variables,dades=dades_temp,valor_outcome=1,conditional = T,strata = "caseid")
M3.reg.plus.G2.ls<-extreure_model_logistic(x="regicor_plus",y="event",taulavariables=conductor_variables,dades=dades_temp,valor_outcome=1,conditional = T,strata = "caseid")


```


# 7. Salvar objectes

```{r salvar_objectes, eval=F, include=F}

rm(list=c("events_dt","dadesevents","dades","dades_temp"))

gc()

save.image(file=output_PRECAV)

```






